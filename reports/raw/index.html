<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Raw News Viewer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Newsreader:wght@400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --primary: #3B82F6;
      --primary-hover: #2563EB;
      --secondary: #60A5FA;
      --cta: #F97316;
      --background: #F8FAFC;
      --surface: #FFFFFF;
      --text: #1E293B;
      --text-muted: #64748B;
      --border: #E2E8F0;
      --code-bg: #F1F5F9;
      --max-width: 800px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --background: #0F172A;
        --surface: #1E293B;
        --text: #F1F5F9;
        --text-muted: #94A3B8;
        --border: #334155;
        --code-bg: #334155;
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    @media (prefers-reduced-motion: reduce) {
      html {
        scroll-behavior: auto;
      }
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }

    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 16px;
      line-height: 1.7;
      color: var(--text);
      background-color: var(--background);
      min-height: 100vh;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.5rem;
    }

    .header-content {
      max-width: var(--max-width);
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .logo {
      font-family: 'Newsreader', Georgia, serif;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: color 200ms ease;
    }

    .logo:hover {
      color: var(--primary);
    }

    .logo svg {
      width: 24px;
      height: 24px;
      color: var(--primary);
    }

    .file-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .file-selector label {
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .file-selector select {
      padding: 0.5rem 2rem 0.5rem 0.75rem;
      font-size: 0.875rem;
      font-family: inherit;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      transition: border-color 200ms ease;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748B'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 1rem;
    }

    .file-selector select:hover,
    .file-selector select:focus {
      border-color: var(--primary);
      outline: none;
    }

    .nav-btn {
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      font-family: inherit;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      transition: border-color 200ms ease, opacity 200ms ease;
      line-height: 1;
    }

    .nav-btn:hover:not(:disabled) {
      border-color: var(--primary);
    }

    .nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    main {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
    }

    .loading,
    .error,
    .empty {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }

    .error {
      color: #EF4444;
    }

    .error svg,
    .empty svg {
      width: 48px;
      height: 48px;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .content {
      animation: fadeIn 300ms ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .content h1 {
      font-family: 'Newsreader', Georgia, serif;
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      line-height: 1.3;
      color: var(--text);
    }

    .content h2 {
      font-family: 'Newsreader', Georgia, serif;
      font-size: 1.5rem;
      font-weight: 600;
      margin: 2.5rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary);
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .content h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 2rem 0 0.75rem;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .content h4 {
      font-size: 1.1rem;
      font-weight: 500;
      margin: 1.5rem 0 0.5rem;
      color: var(--text);
    }

    .content p {
      margin-bottom: 1rem;
    }

    .content a {
      color: var(--primary);
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: border-color 200ms ease;
    }

    .content a:hover {
      border-bottom-color: var(--primary);
    }

    .content ul,
    .content ol {
      margin: 1rem 0;
      padding-left: 1.5rem;
    }

    .content li {
      margin-bottom: 0.5rem;
    }

    .content li > ul,
    .content li > ol {
      margin: 0.5rem 0;
    }

    .content blockquote {
      margin: 1.5rem 0;
      padding: 1rem 1.5rem;
      border-left: 4px solid var(--primary);
      background: var(--code-bg);
      border-radius: 0 6px 6px 0;
      color: var(--text-muted);
      font-style: italic;
    }

    .content code {
      font-family: 'SF Mono', Menlo, Monaco, monospace;
      font-size: 0.875em;
      padding: 0.2em 0.4em;
      background: var(--code-bg);
      border-radius: 4px;
    }

    .content pre {
      margin: 1.5rem 0;
      padding: 1rem;
      background: var(--code-bg);
      border-radius: 8px;
      overflow-x: auto;
    }

    .content pre code {
      padding: 0;
      background: none;
    }

    .content hr {
      margin: 2rem 0;
      border: none;
      border-top: 1px solid var(--border);
    }

    .content table {
      width: 100%;
      margin: 1.5rem 0;
      border-collapse: collapse;
      font-size: 0.9375rem;
    }

    .content th,
    .content td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .content th {
      font-weight: 600;
      background: var(--code-bg);
    }

    .content img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 1rem 0;
    }

    .content strong {
      font-weight: 600;
    }

    footer {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 2rem 1.5rem;
      border-top: 1px solid var(--border);
      text-align: center;
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    footer a {
      color: var(--primary);
      text-decoration: none;
      cursor: pointer;
      transition: color 200ms ease;
    }

    footer a:hover {
      color: var(--primary-hover);
    }

    @media (max-width: 640px) {
      .header-content {
        flex-direction: column;
        align-items: flex-start;
      }

      .content h1 {
        font-size: 1.5rem;
      }

      .content h2 {
        font-size: 1.25rem;
      }
    }

    /* TTS 播放控制樣式 */
    .tts-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .tts-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      padding: 0.5rem 0.875rem;
      font-size: 0.875rem;
      font-family: inherit;
      font-weight: 500;
      border: none;
      border-radius: 9999px;
      cursor: pointer;
      transition: all 200ms ease;
      white-space: nowrap;
    }

    .tts-btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    .tts-btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .tts-btn-primary:active {
      transform: translateY(0);
    }

    .tts-btn-primary.playing {
      background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .tts-btn-primary.playing:hover {
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .tts-btn-icon {
      padding: 0.5rem;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .tts-btn-icon:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .tts-btn svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .tts-checkbox {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.8125rem;
      color: var(--text-muted);
      cursor: pointer;
      user-select: none;
    }

    .tts-checkbox input {
      width: 14px;
      height: 14px;
      accent-color: var(--primary);
      cursor: pointer;
    }

    /* 單項播放按鈕 */
    .item-play-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      padding: 0;
      border: none;
      border-radius: 50%;
      background: var(--code-bg);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 200ms ease;
      flex-shrink: 0;
      opacity: 0.7;
    }

    .item-play-btn:hover {
      background: var(--primary);
      color: white;
      opacity: 1;
      transform: scale(1.1);
    }

    .item-play-btn.playing {
      background: #EF4444;
      color: white;
      opacity: 1;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .item-play-btn svg {
      width: 14px;
      height: 14px;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* 播放中的新聞項目高亮 */
    .news-section.playing {
      position: relative;
    }

    .news-section.playing::before {
      content: '';
      position: absolute;
      left: -1rem;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--primary);
      border-radius: 2px;
    }

    /* 設定 Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: all 200ms ease;
    }

    .modal-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      transform: translateY(20px);
      transition: transform 200ms ease;
    }

    .modal-overlay.open .modal {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .modal-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text);
    }

    .modal-close {
      padding: 0.25rem;
      border: none;
      background: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 4px;
      transition: color 200ms ease;
    }

    .modal-close:hover {
      color: var(--text);
    }

    .modal-close svg {
      width: 20px;
      height: 20px;
    }

    .modal-body {
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 0.375rem;
    }

    .form-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .form-input {
      width: 100%;
      padding: 0.625rem 0.75rem;
      font-size: 0.875rem;
      font-family: inherit;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--background);
      color: var(--text);
      transition: border-color 200ms ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-select {
      width: 100%;
      padding: 0.625rem 2rem 0.625rem 0.75rem;
      font-size: 0.875rem;
      font-family: inherit;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--background);
      color: var(--text);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748B'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 1rem;
    }

    .form-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .modal-footer {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    .btn {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-family: inherit;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      transition: all 200ms ease;
    }

    .btn-secondary {
      background: var(--code-bg);
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      border-color: var(--primary);
    }

    .btn-primary {
      background: var(--primary);
      border: 1px solid var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
    }

    /* TTS 狀態指示 */
    .tts-status {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .tts-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .tts-status-dot.azure {
      background: #10B981;
    }

    .tts-status-dot.google {
      background: #4285F4;
    }

    .tts-status-dot.gemini {
      background: #8B5CF6;
    }

    .tts-status-dot.fish {
      background: #06B6D4;
    }

    .tts-status-dot.web {
      background: #F59E0B;
    }

    /* 自動播放啟動覆蓋層 */
    .autoplay-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(8px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: all 300ms ease;
      cursor: pointer;
    }

    .autoplay-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .autoplay-overlay-content {
      text-align: center;
      color: white;
      animation: float 2s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .autoplay-icon {
      width: 80px;
      height: 80px;
      margin-bottom: 1.5rem;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 32px rgba(59, 130, 246, 0.4);
    }

    .autoplay-icon svg {
      width: 36px;
      height: 36px;
      color: white;
      margin-left: 4px;
    }

    .autoplay-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .autoplay-hint {
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    @media (max-width: 640px) {
      .tts-controls {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }

      .tts-btn span {
        display: none;
      }

      .tts-btn svg {
        width: 18px;
        height: 18px;
      }

      .tts-checkbox span {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <a href="index.html" class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" />
        </svg>
        Raw News Viewer
      </a>
      <div class="file-selector">
        <button id="prev-btn" class="nav-btn" aria-label="上一篇" disabled>←</button>
        <select id="month-select" aria-label="選擇年月"></select>
        <select id="day-select" aria-label="選擇日期"></select>
        <select id="time-select" aria-label="選擇時間"></select>
        <button id="next-btn" class="nav-btn" aria-label="下一篇" disabled>→</button>
      </div>
      <div class="tts-controls">
        <button id="play-all-btn" class="tts-btn tts-btn-primary" aria-label="全部播放">
          <svg id="play-all-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <span>全部播放</span>
        </button>
        <label class="tts-checkbox">
          <input type="checkbox" id="auto-play-checkbox">
          <span>自動播放</span>
        </label>
        <button id="tts-settings-btn" class="tts-btn tts-btn-icon" aria-label="語音設定">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
          </svg>
        </button>
        <div class="tts-status">
          <span class="tts-status-dot" id="tts-status-dot"></span>
          <span id="tts-status-text">Web Speech</span>
        </div>
      </div>
    </div>
  </header>

  <main id="main">
    <div class="empty">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
      </svg>
      <p>請選擇報告檔案</p>
    </div>
  </main>

  <footer>
    <p>Powered by <a href="https://github.com/yelban/erduo-skills.TW">吹水乜野</a></p>
  </footer>

  <!-- 自動播放啟動覆蓋層 -->
  <div id="autoplay-overlay" class="autoplay-overlay">
    <div class="autoplay-overlay-content">
      <div class="autoplay-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
          <path d="M8 5v14l11-7z"/>
        </svg>
      </div>
      <div class="autoplay-title">點擊開始播放</div>
      <div class="autoplay-hint">瀏覽器需要互動才能播放音訊</div>
    </div>
  </div>

  <!-- TTS 設定 Modal -->
  <div id="tts-settings-modal" class="modal-overlay">
    <div class="modal" role="dialog" aria-labelledby="modal-title">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-title">語音設定</h3>
        <button id="modal-close-btn" class="modal-close" aria-label="關閉">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="tts-engine-select">語音引擎</label>
          <select id="tts-engine-select" class="form-select">
            <option value="web">Web Speech API（免費）</option>
            <option value="azure">Azure TTS（高品質）</option>
            <option value="google">Google Cloud TTS（免費額度多）</option>
            <option value="gemini">Gemini TTS（最自然）</option>
            <option value="fish">Fish Audio（台灣腔）</option>
          </select>
          <p class="form-hint" id="engine-hint">Gemini TTS 最自然，可用提示控制語調</p>
        </div>
        <div id="azure-settings" class="form-group" style="display: none;">
          <label class="form-label" for="azure-key-input">Azure API Key</label>
          <input type="password" id="azure-key-input" class="form-input" placeholder="輸入您的 Azure Speech API Key">
          <p class="form-hint">從 Azure Portal 取得 Speech 服務的 API Key（免費 50 萬字/月）</p>
        </div>
        <div id="azure-region-settings" class="form-group" style="display: none;">
          <label class="form-label" for="azure-region-input">Azure 區域</label>
          <input type="text" id="azure-region-input" class="form-input" placeholder="eastasia" value="eastasia">
          <p class="form-hint">例如：eastasia、southeastasia、westus</p>
        </div>
        <div id="azure-proxy-settings" class="form-group" style="display: none;">
          <label class="form-label" for="azure-proxy-input">代理 URL（選填）</label>
          <input type="text" id="azure-proxy-input" class="form-input" placeholder="https://azure-tts.twampd.workers.dev">
          <p class="form-hint">使用代理時無需輸入 API Key，Key 由代理伺服器管理</p>
        </div>
        <div id="google-settings" class="form-group" style="display: none;">
          <label class="form-label" for="google-key-input">Google Cloud API Key</label>
          <input type="password" id="google-key-input" class="form-input" placeholder="輸入您的 Google Cloud API Key">
          <p class="form-hint">從 Google Cloud Console 取得 Text-to-Speech API Key（免費 100 萬字/月）</p>
        </div>
        <div id="gemini-settings" class="form-group" style="display: none;">
          <label class="form-label" for="gemini-key-input">Gemini API Key</label>
          <input type="password" id="gemini-key-input" class="form-input" placeholder="輸入您的 Gemini API Key">
          <p class="form-hint">從 <a href="https://aistudio.google.com/apikey" target="_blank">AI Studio</a> 取得 API Key</p>
        </div>
        <div id="gemini-voice-settings" class="form-group" style="display: none;">
          <label class="form-label" for="gemini-voice-select">語音角色</label>
          <select id="gemini-voice-select" class="form-select">
            <option value="Kore">Kore（女聲，溫暖）</option>
            <option value="Charon">Charon（男聲，沉穩）</option>
            <option value="Fenrir">Fenrir（男聲，有力）</option>
            <option value="Aoede">Aoede（女聲，清亮）</option>
            <option value="Puck">Puck（中性，活潑）</option>
            <option value="Zephyr">Zephyr（中性，輕柔）</option>
          </select>
        </div>
        <div id="fish-settings" class="form-group" style="display: none;">
          <label class="form-label" for="fish-key-input">Fish Audio API Key</label>
          <input type="password" id="fish-key-input" class="form-input" placeholder="輸入您的 Fish Audio API Key">
          <p class="form-hint">從 <a href="https://fish.audio/zh-TW/" target="_blank">Fish Audio</a> 取得 API Key</p>
        </div>
        <div id="fish-voice-settings" class="form-group" style="display: none;">
          <label class="form-label" for="fish-voice-input">語音模型 ID</label>
          <input type="text" id="fish-voice-input" class="form-input" placeholder="輸入語音模型 ID（如：台灣女生）">
          <p class="form-hint">在 <a href="https://fish.audio/zh-TW/discover" target="_blank">Fish Audio 發現</a> 搜尋「台灣」找到喜歡的語音</p>
        </div>
        <div id="fish-proxy-settings" class="form-group" style="display: none;">
          <label class="form-label" for="fish-proxy-input">代理 URL（選填）</label>
          <input type="text" id="fish-proxy-input" class="form-input" placeholder="https://fish-tts.twampd.workers.dev">
          <p class="form-hint">瀏覽器有 CORS 限制，需透過代理呼叫。留空則自動降級至 Web Speech API</p>
        </div>
        <div class="form-group">
          <label class="form-label" for="speech-rate-select">語速</label>
          <select id="speech-rate-select" class="form-select">
            <option value="0.8">較慢 (0.8x)</option>
            <option value="1" selected>正常 (1x)</option>
            <option value="1.2">較快 (1.2x)</option>
            <option value="1.5">快速 (1.5x)</option>
          </select>
        </div>
        <div class="form-group">
          <button id="test-tts-btn" class="btn btn-secondary" style="width: 100%;">
            測試語音
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button id="modal-cancel-btn" class="btn btn-secondary">取消</button>
        <button id="modal-save-btn" class="btn btn-primary">儲存</button>
      </div>
    </div>
  </div>

  <script>
    // ========== 檔案偵測與選擇邏輯 ==========

    const main = document.getElementById('main');
    const monthSelect = document.getElementById('month-select');
    const daySelect = document.getElementById('day-select');
    const timeSelect = document.getElementById('time-select');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');

    // 報告列表與分組
    let reportsList = [];
    let groupedByMonth = {};
    let groupedByDay = {};

    // Cache-busting 參數
    const cacheBuster = `?v=${Math.floor(Date.now() / 60000)}`;

    // 檔名解析 patterns（可擴展）
    const patterns = [
      {
        // global_scan_20260124_1542
        regex: /^(?<prefix>.+)_(?<ymd>\d{8})_(?<hm>\d{4})$/,
        map: (m) => ({ ymd: m.groups.ymd, hm: m.groups.hm })
      },
      {
        // 20260124_1542_anything
        regex: /^(?<ymd>\d{8})_(?<hm>\d{4})_(?<suffix>.+)$/,
        map: (m) => ({ ymd: m.groups.ymd, hm: m.groups.hm })
      },
      {
        // 20260124-1542 or 20260124-1542-report
        regex: /^(?<ymd>\d{8})-(?<hm>\d{4})(?:-.+)?$/,
        map: (m) => ({ ymd: m.groups.ymd, hm: m.groups.hm })
      }
    ];

    // 解析檔名
    function parseFilename(baseName) {
      for (const pattern of patterns) {
        const match = baseName.match(pattern.regex);
        if (match) {
          const { ymd, hm } = pattern.map(match);
          const yyyy = ymd.slice(0, 4);
          const mm = ymd.slice(4, 6);
          const dd = ymd.slice(6, 8);
          const hh = hm.slice(0, 2);
          const min = hm.slice(2, 4);
          return {
            baseName,
            yyyy, mm, dd, hh, min,
            monthKey: `${yyyy}-${mm}`,
            dayKey: dd,
            timeKey: `${hh}:${min}`,
            sortKey: `${ymd}${hm}`
          };
        }
      }
      return null;
    }

    // 從 reports.json 載入報告列表
    async function detectReports() {
      try {
        const response = await fetch('reports.json' + cacheBuster);
        if (!response.ok) {
          console.warn('無法載入 reports.json，回退到輪詢模式');
          return await detectReportsFallback();
        }
        const data = await response.json();

        // 支援 {"reports":["name"]} 或 [{"file":"name"}] 格式
        let fileNames = [];
        if (Array.isArray(data.reports)) {
          fileNames = data.reports;
        } else if (Array.isArray(data)) {
          fileNames = data.map(item => item.file || item);
        }

        const reports = [];
        for (const name of fileNames) {
          const baseName = name.replace(/\.md$/, '');
          const parsed = parseFilename(baseName);
          if (parsed) {
            reports.push(parsed);
          }
        }
        return reports.sort((a, b) => b.sortKey.localeCompare(a.sortKey));
      } catch (e) {
        console.warn('載入報告索引失敗，回退到輪詢模式', e);
        return await detectReportsFallback();
      }
    }

    // 備援：輪詢檢查報告
    async function detectReportsFallback() {
      const reports = [];

      // 嘗試從 URL 參數取得
      const params = new URLSearchParams(window.location.search);
      const fileParam = params.get('file');
      if (fileParam) {
        const parsed = parseFilename(fileParam);
        if (parsed) {
          try {
            const response = await fetch(`${fileParam}.md` + cacheBuster, { method: 'HEAD' });
            if (response.ok) {
              reports.push(parsed);
            }
          } catch (e) {}
        }
      }

      // 嘗試探測最近 48 小時的檔案
      const now = new Date();
      const prefixes = ['global_scan'];

      for (let hourOffset = 0; hourOffset < 48; hourOffset++) {
        const time = new Date(now.getTime() - hourOffset * 60 * 60 * 1000);
        const ymd = time.toISOString().slice(0, 10).replace(/-/g, '');
        const hh = String(time.getHours()).padStart(2, '0');

        for (const min of ['00', '30']) {
          for (const prefix of prefixes) {
            const baseName = `${prefix}_${ymd}_${hh}${min}`;
            if (reports.some(r => r.baseName === baseName)) continue;

            try {
              const response = await fetch(`${baseName}.md` + cacheBuster, { method: 'HEAD' });
              if (response.ok) {
                const parsed = parseFilename(baseName);
                if (parsed) reports.push(parsed);
              }
            } catch (e) {}
          }
        }
      }

      return reports.sort((a, b) => b.sortKey.localeCompare(a.sortKey));
    }

    // 取得當前選中的 baseName
    function getCurrentBaseName() {
      const month = monthSelect.value;
      const day = daySelect.value;
      const time = timeSelect.value;
      if (!month || !day || !time) return null;

      const key = `${month}-${day}-${time}`;
      for (const report of reportsList) {
        if (`${report.monthKey}-${report.dayKey}-${report.timeKey}` === key) {
          return report.baseName;
        }
      }
      return null;
    }

    // 根據年月填充日期選單
    function populateDaySelect(month, selectedDay = null) {
      const days = groupedByMonth[month] || [];
      const uniqueDays = [...new Set(days.map(r => r.dayKey))].sort((a, b) => b.localeCompare(a));

      if (uniqueDays.length === 0) {
        daySelect.innerHTML = '<option value="">無可用日期</option>';
        timeSelect.innerHTML = '<option value="">無可用時間</option>';
        return;
      }

      daySelect.innerHTML = uniqueDays.map(day =>
        `<option value="${day}">${day}</option>`
      ).join('');

      if (selectedDay && uniqueDays.includes(selectedDay)) {
        daySelect.value = selectedDay;
      } else {
        daySelect.value = uniqueDays[0];
      }

      populateTimeSelect(month, daySelect.value);
    }

    // 根據年月和日期填充時間選單
    function populateTimeSelect(month, day, selectedTime = null) {
      const key = `${month}-${day}`;
      const times = (groupedByMonth[month] || [])
        .filter(r => r.dayKey === day)
        .map(r => r.timeKey)
        .sort((a, b) => b.localeCompare(a));

      if (times.length === 0) {
        timeSelect.innerHTML = '<option value="">無可用時間</option>';
        return;
      }

      timeSelect.innerHTML = times.map(time =>
        `<option value="${time}">${time}</option>`
      ).join('');

      if (selectedTime && times.includes(selectedTime)) {
        timeSelect.value = selectedTime;
      } else {
        timeSelect.value = times[0];
      }
    }

    // 填充月份選單
    async function populateSelect() {
      const reports = await detectReports();
      reportsList = reports;

      if (reports.length === 0) {
        monthSelect.innerHTML = '<option value="">無可用報告</option>';
        daySelect.innerHTML = '<option value=""></option>';
        timeSelect.innerHTML = '<option value=""></option>';
        updateNavButtons();
        return;
      }

      // 按月份分組
      groupedByMonth = {};
      reports.forEach(r => {
        if (!groupedByMonth[r.monthKey]) groupedByMonth[r.monthKey] = [];
        groupedByMonth[r.monthKey].push(r);
      });

      // 填充月份選單（降序：最新在前）
      const months = Object.keys(groupedByMonth).sort((a, b) => b.localeCompare(a));
      monthSelect.innerHTML = months.map(month =>
        `<option value="${month}">${month}</option>`
      ).join('');

      // 檢查 URL 參數
      const params = new URLSearchParams(window.location.search);
      const fileParam = params.get('file');

      if (fileParam) {
        const parsed = parseFilename(fileParam);
        if (parsed && reports.some(r => r.baseName === parsed.baseName)) {
          monthSelect.value = parsed.monthKey;
          populateDaySelect(parsed.monthKey, parsed.dayKey);
          populateTimeSelect(parsed.monthKey, parsed.dayKey, parsed.timeKey);
          loadReport(parsed.baseName);
        } else {
          monthSelect.value = months[0];
          populateDaySelect(months[0]);
          loadReport(reports[0].baseName);
        }
      } else if (reports.length > 0) {
        monthSelect.value = months[0];
        populateDaySelect(months[0]);
        loadReport(reports[0].baseName);
      }

      updateNavButtons();
    }

    // 載入並渲染報告
    async function loadReport(baseName) {
      if (!baseName) return;

      // 更新 URL
      const url = new URL(window.location);
      url.searchParams.set('file', baseName);
      window.history.pushState({}, '', url);

      // 顯示載入中
      main.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>載入中...</p>
        </div>
      `;

      try {
        const response = await fetch(`${baseName}.md` + cacheBuster);

        if (!response.ok) {
          throw new Error(`檔案不存在: ${baseName}.md`);
        }

        let markdown = await response.text();

        // 移除報告標頭的「生成耗時」和「早停觸發」行
        markdown = markdown
          .split('\n')
          .filter(line => !line.match(/^>\s*(生成耗時|早停觸發)/))
          .join('\n');

        const html = marked.parse(markdown);

        main.innerHTML = `<article class="content">${html}</article>`;

        // 捲動到頂部
        window.scrollTo({ top: 0, behavior: 'smooth' });

        // 報告載入後添加播放按鈕
        setTimeout(() => {
          addPlayButtons();
          if (autoPlayCheckbox.checked && !isPlayingAll) {
            setTimeout(() => showAutoplayOverlay(), 500);
          }
        }, 100);

      } catch (error) {
        main.innerHTML = `
          <div class="error">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
            </svg>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    // 更新導航按鈕狀態
    function updateNavButtons() {
      const currentBaseName = getCurrentBaseName();
      const currentIndex = reportsList.findIndex(r => r.baseName === currentBaseName);
      prevBtn.disabled = currentIndex < 0 || currentIndex >= reportsList.length - 1;
      nextBtn.disabled = currentIndex <= 0;
    }

    // 前後導航
    function navigateReport(direction) {
      const currentBaseName = getCurrentBaseName();
      const currentIndex = reportsList.findIndex(r => r.baseName === currentBaseName);
      const newIndex = currentIndex + direction;

      if (newIndex >= 0 && newIndex < reportsList.length) {
        const newReport = reportsList[newIndex];

        if (newReport.monthKey !== monthSelect.value) {
          monthSelect.value = newReport.monthKey;
          populateDaySelect(newReport.monthKey, newReport.dayKey);
          populateTimeSelect(newReport.monthKey, newReport.dayKey, newReport.timeKey);
        } else if (newReport.dayKey !== daySelect.value) {
          daySelect.value = newReport.dayKey;
          populateTimeSelect(newReport.monthKey, newReport.dayKey, newReport.timeKey);
        } else {
          timeSelect.value = newReport.timeKey;
        }

        loadReport(newReport.baseName);
        updateNavButtons();
      }
    }

    // 事件監聽
    monthSelect.addEventListener('change', (e) => {
      populateDaySelect(e.target.value);
      const baseName = getCurrentBaseName();
      if (baseName) loadReport(baseName);
      updateNavButtons();
    });

    daySelect.addEventListener('change', (e) => {
      populateTimeSelect(monthSelect.value, e.target.value);
      const baseName = getCurrentBaseName();
      if (baseName) loadReport(baseName);
      updateNavButtons();
    });

    timeSelect.addEventListener('change', () => {
      const baseName = getCurrentBaseName();
      if (baseName) loadReport(baseName);
      updateNavButtons();
    });

    prevBtn.addEventListener('click', () => navigateReport(1));
    nextBtn.addEventListener('click', () => navigateReport(-1));

    // 處理瀏覽器前進/後退
    window.addEventListener('popstate', () => {
      const params = new URLSearchParams(window.location.search);
      const fileParam = params.get('file');
      if (fileParam) {
        const parsed = parseFilename(fileParam);
        if (parsed) {
          monthSelect.value = parsed.monthKey;
          populateDaySelect(parsed.monthKey, parsed.dayKey);
          populateTimeSelect(parsed.monthKey, parsed.dayKey, parsed.timeKey);
          loadReport(parsed.baseName);
          updateNavButtons();
        }
      }
    });

    // 初始化
    populateSelect();

    // ========== TTS 功能 ==========

    const playAllBtn = document.getElementById('play-all-btn');
    const playAllIcon = document.getElementById('play-all-icon');
    const autoPlayCheckbox = document.getElementById('auto-play-checkbox');
    const ttsSettingsBtn = document.getElementById('tts-settings-btn');
    const ttsStatusDot = document.getElementById('tts-status-dot');
    const ttsStatusText = document.getElementById('tts-status-text');

    const ttsModal = document.getElementById('tts-settings-modal');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const modalSaveBtn = document.getElementById('modal-save-btn');
    const ttsEngineSelect = document.getElementById('tts-engine-select');
    const azureSettings = document.getElementById('azure-settings');
    const azureRegionSettings = document.getElementById('azure-region-settings');
    const azureProxySettings = document.getElementById('azure-proxy-settings');
    const azureKeyInput = document.getElementById('azure-key-input');
    const azureRegionInput = document.getElementById('azure-region-input');
    const azureProxyInput = document.getElementById('azure-proxy-input');
    const googleSettings = document.getElementById('google-settings');
    const googleKeyInput = document.getElementById('google-key-input');
    const geminiSettings = document.getElementById('gemini-settings');
    const geminiVoiceSettings = document.getElementById('gemini-voice-settings');
    const geminiKeyInput = document.getElementById('gemini-key-input');
    const geminiVoiceSelect = document.getElementById('gemini-voice-select');
    const fishSettings = document.getElementById('fish-settings');
    const fishVoiceSettings = document.getElementById('fish-voice-settings');
    const fishProxySettings = document.getElementById('fish-proxy-settings');
    const fishKeyInput = document.getElementById('fish-key-input');
    const fishVoiceInput = document.getElementById('fish-voice-input');
    const fishProxyInput = document.getElementById('fish-proxy-input');
    const speechRateSelect = document.getElementById('speech-rate-select');
    const testTtsBtn = document.getElementById('test-tts-btn');
    const engineHint = document.getElementById('engine-hint');

    let ttsConfig = {
      engine: 'azure',
      azureKey: '',
      azureRegion: 'eastasia',
      azureProxy: 'https://azure-tts.twampd.workers.dev',
      googleKey: '',
      geminiKey: '',
      geminiVoice: 'Kore',
      fishKey: '',
      fishVoice: '',
      fishProxy: 'https://fish-tts.twampd.workers.dev',
      rate: 1
    };
    let isPlayingAll = false;
    let currentPlayingIndex = -1;
    let currentAudio = null;
    let currentUtterance = null;

    function loadTtsConfig() {
      const saved = localStorage.getItem('ttsConfig');
      if (saved) {
        try {
          ttsConfig = { ...ttsConfig, ...JSON.parse(saved) };
        } catch (e) {
          console.warn('載入 TTS 設定失敗', e);
        }
      }
      autoPlayCheckbox.checked = localStorage.getItem('autoPlay') === 'true';
      updateTtsStatus();
    }

    function saveTtsConfig() {
      localStorage.setItem('ttsConfig', JSON.stringify(ttsConfig));
    }

    function updateTtsStatus() {
      if (ttsConfig.engine === 'azure' && (ttsConfig.azureKey || ttsConfig.azureProxy)) {
        ttsStatusDot.className = 'tts-status-dot azure';
        ttsStatusText.textContent = 'Azure TTS';
      } else if (ttsConfig.engine === 'google' && ttsConfig.googleKey) {
        ttsStatusDot.className = 'tts-status-dot google';
        ttsStatusText.textContent = 'Google TTS';
      } else if (ttsConfig.engine === 'gemini' && ttsConfig.geminiKey) {
        ttsStatusDot.className = 'tts-status-dot gemini';
        ttsStatusText.textContent = 'Gemini TTS';
      } else if (ttsConfig.engine === 'fish' && ttsConfig.fishKey) {
        ttsStatusDot.className = 'tts-status-dot fish';
        ttsStatusText.textContent = 'Fish Audio';
      } else {
        ttsStatusDot.className = 'tts-status-dot web';
        ttsStatusText.textContent = 'Web Speech';
      }
    }

    function webSpeechTTS(text) {
      return new Promise((resolve, reject) => {
        if (!('speechSynthesis' in window)) {
          reject(new Error('瀏覽器不支援 Web Speech API'));
          return;
        }

        speechSynthesis.cancel();

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-TW';
        utterance.rate = ttsConfig.rate;

        const voices = speechSynthesis.getVoices();
        const twVoice = voices.find(v =>
          v.lang === 'zh-TW' ||
          v.name.includes('Taiwan') ||
          v.name.includes('台灣') ||
          v.name.includes('國語')
        );
        if (twVoice) {
          utterance.voice = twVoice;
        }

        currentUtterance = utterance;

        utterance.onend = () => {
          currentUtterance = null;
          resolve();
        };

        utterance.onerror = (event) => {
          currentUtterance = null;
          if (event.error !== 'canceled') {
            reject(new Error(event.error));
          } else {
            resolve();
          }
        };

        speechSynthesis.speak(utterance);
      });
    }

    async function azureTTS(text) {
      const ssml = `
        <speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xml:lang='zh-TW'>
          <voice name='zh-TW-HsiaoChenNeural'>
            <prosody rate='${ttsConfig.rate}'>
              ${text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}
            </prosody>
          </voice>
        </speak>
      `;

      let response;
      if (ttsConfig.azureProxy) {
        response = await fetch(ttsConfig.azureProxy, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/ssml+xml'
          },
          body: ssml
        });
      } else {
        const endpoint = `https://${ttsConfig.azureRegion}.tts.speech.microsoft.com/cognitiveservices/v1`;
        response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Ocp-Apim-Subscription-Key': ttsConfig.azureKey,
            'Content-Type': 'application/ssml+xml',
            'X-Microsoft-OutputFormat': 'audio-16khz-128kbitrate-mono-mp3'
          },
          body: ssml
        });
      }

      if (!response.ok) {
        throw new Error(`Azure TTS 錯誤: ${response.status}`);
      }

      const audioBlob = await response.blob();
      const audioUrl = URL.createObjectURL(audioBlob);

      return new Promise((resolve, reject) => {
        const audio = new Audio(audioUrl);
        currentAudio = audio;

        audio.onended = () => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          resolve();
        };

        audio.onerror = (e) => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          reject(new Error('音訊播放失敗'));
        };

        audio.play().catch(reject);
      });
    }

    async function googleTTS(text) {
      const endpoint = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${ttsConfig.googleKey}`;

      const requestBody = {
        input: { text: text },
        voice: {
          languageCode: 'cmn-TW',
          name: 'cmn-TW-Wavenet-A',
          ssmlGender: 'FEMALE'
        },
        audioConfig: {
          audioEncoding: 'MP3',
          speakingRate: ttsConfig.rate,
          pitch: 0
        }
      };

      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(`Google TTS 錯誤: ${response.status} - ${error.error?.message || '未知錯誤'}`);
      }

      const data = await response.json();
      const audioContent = data.audioContent;

      const audioBlob = await fetch(`data:audio/mp3;base64,${audioContent}`).then(r => r.blob());
      const audioUrl = URL.createObjectURL(audioBlob);

      return new Promise((resolve, reject) => {
        const audio = new Audio(audioUrl);
        currentAudio = audio;

        audio.onended = () => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          resolve();
        };

        audio.onerror = (e) => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          reject(new Error('音訊播放失敗'));
        };

        audio.play().catch(reject);
      });
    }

    function createWavHeader(dataLength, sampleRate, numChannels, bitsPerSample) {
      const byteRate = sampleRate * numChannels * bitsPerSample / 8;
      const blockAlign = numChannels * bitsPerSample / 8;
      const buffer = new ArrayBuffer(44);
      const view = new DataView(buffer);

      function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
          view.setUint8(offset + i, string.charCodeAt(i));
        }
      }

      writeString(view, 0, 'RIFF');
      view.setUint32(4, 36 + dataLength, true);
      writeString(view, 8, 'WAVE');
      writeString(view, 12, 'fmt ');
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true);
      view.setUint16(22, numChannels, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, byteRate, true);
      view.setUint16(32, blockAlign, true);
      view.setUint16(34, bitsPerSample, true);
      writeString(view, 36, 'data');
      view.setUint32(40, dataLength, true);

      return new Uint8Array(buffer);
    }

    async function geminiTTS(text) {
      const model = 'gemini-2.5-flash-preview-tts';
      const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${ttsConfig.geminiKey}`;

      const requestBody = {
        contents: [{
          parts: [{ text: `請朗讀：${text}` }]
        }],
        generationConfig: {
          responseModalities: ['AUDIO'],
          speechConfig: {
            voiceConfig: {
              prebuiltVoiceConfig: {
                voiceName: ttsConfig.geminiVoice
              }
            }
          }
        }
      };

      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(`Gemini TTS 錯誤: ${response.status} - ${error.error?.message || '未知錯誤'}`);
      }

      const data = await response.json();
      const audioData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
      const mimeType = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;

      if (!audioData) {
        throw new Error('Gemini TTS 未返回音訊資料: ' + JSON.stringify(data.error || data));
      }

      const binaryString = atob(audioData);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }

      let audioBlob;
      if (mimeType && mimeType.includes('L16')) {
        const wavHeader = createWavHeader(bytes.length, 24000, 1, 16);
        const wavData = new Uint8Array(wavHeader.length + bytes.length);
        wavData.set(wavHeader, 0);
        wavData.set(bytes, wavHeader.length);
        audioBlob = new Blob([wavData], { type: 'audio/wav' });
      } else {
        audioBlob = new Blob([bytes], { type: mimeType || 'audio/mp3' });
      }
      const audioUrl = URL.createObjectURL(audioBlob);

      return new Promise((resolve, reject) => {
        const audio = new Audio(audioUrl);
        currentAudio = audio;
        audio.playbackRate = ttsConfig.rate;

        audio.onended = () => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          resolve();
        };

        audio.onerror = (e) => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          reject(new Error('音訊播放失敗'));
        };

        audio.play().catch(reject);
      });
    }

    async function fishAudioTTS(text) {
      if (!ttsConfig.fishKey) {
        throw new Error('請先設定 Fish Audio API Key');
      }

      const endpoint = ttsConfig.fishProxy || 'https://api.fish.audio/v1/tts';

      const requestBody = {
        text: text,
        format: 'mp3',
        mp3_bitrate: 128,
        normalize: true,
        latency: 'normal'
      };

      if (ttsConfig.fishVoice) {
        requestBody.reference_id = ttsConfig.fishVoice;
      }

      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${ttsConfig.fishKey}`,
          'Content-Type': 'application/json',
          'model': 's1'
        },
        body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(`Fish Audio 錯誤: ${response.status} - ${error.message || '未知錯誤'}`);
      }

      const audioBlob = await response.blob();
      const audioUrl = URL.createObjectURL(audioBlob);

      return new Promise((resolve, reject) => {
        const audio = new Audio(audioUrl);
        currentAudio = audio;
        audio.playbackRate = ttsConfig.rate;

        audio.onended = () => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          resolve();
        };

        audio.onerror = () => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          reject(new Error('Fish Audio 播放失敗'));
        };

        audio.play().catch(reject);
      });
    }

    async function speak(text) {
      if (ttsConfig.engine === 'azure' && (ttsConfig.azureKey || ttsConfig.azureProxy)) {
        try {
          await azureTTS(text);
        } catch (e) {
          console.warn('Azure TTS 失敗，降級至 Web Speech API', e);
          await webSpeechTTS(text);
        }
      } else if (ttsConfig.engine === 'google' && ttsConfig.googleKey) {
        try {
          await googleTTS(text);
        } catch (e) {
          console.warn('Google TTS 失敗，降級至 Web Speech API', e);
          await webSpeechTTS(text);
        }
      } else if (ttsConfig.engine === 'gemini' && ttsConfig.geminiKey) {
        try {
          await geminiTTS(text);
        } catch (e) {
          console.warn('Gemini TTS 失敗，降級至 Web Speech API', e);
          await webSpeechTTS(text);
        }
      } else if (ttsConfig.engine === 'fish' && ttsConfig.fishKey) {
        try {
          await fishAudioTTS(text);
        } catch (e) {
          console.warn('Fish Audio 失敗，降級至 Web Speech API', e);
          await webSpeechTTS(text);
        }
      } else {
        await webSpeechTTS(text);
      }
    }

    function stopSpeaking() {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      if (currentUtterance) {
        speechSynthesis.cancel();
        currentUtterance = null;
      }
    }

    // 判斷區塊類型
    function getSectionType(h2Text) {
      if (h2Text.includes('頭條精選')) return 'top10';
      if (h2Text.includes('歐美') || h2Text.includes('🇺🇸')) return 'western';
      if (h2Text.includes('日本') || h2Text.includes('🇯🇵')) return 'japan';
      if (h2Text.includes('台灣') || h2Text.includes('🇹🇼')) return 'taiwan';
      if (h2Text.includes('中國') || h2Text.includes('🇨🇳')) return 'china';
      return 'other';
    }

    // 提取頭條精選項目內容（標題 + 簡介 + 核心觀點 + 啟發）
    function extractTopNewsContent(section) {
      const heading = section.heading;
      if (!heading) return '';

      // 提取標題（去掉數字和連結）
      const linkEl = heading.querySelector('a');
      const titleText = linkEl
        ? linkEl.textContent.trim()
        : heading.textContent.replace(/^\d+\.\s*/, '').trim();

      const parts = [titleText];

      // 找到簡介（h3 後面的第一段非 📊 開頭的 p 元素）
      for (const el of section.contentElements) {
        if (el.tagName === 'P') {
          const text = el.textContent.trim();
          // 跳過來源資訊行（📊 開頭）
          if (!text.startsWith('📊')) {
            parts.push(text);
            break;
          }
        }
      }

      // 找核心觀點和啟發
      const items = [];
      for (const el of section.contentElements) {
        if (el.tagName === 'UL') {
          const lis = el.querySelectorAll('li');
          for (const li of lis) {
            const text = li.textContent.trim();
            // 核心觀點或爭議焦點
            if (text.includes('核心觀點') || text.includes('爭議焦點')) {
              const match = text.match(/[：:]\s*(.+)/);
              if (match) items.push('核心觀點：' + match[1]);
            }
            // 啟發
            else if (text.includes('啟發')) {
              const match = text.match(/[：:]\s*(.+)/);
              if (match) items.push('啟發：' + match[1]);
            }
          }
          break;
        }
      }

      if (items.length > 0) {
        parts.push(...items);
      }

      return parts.join('。');
    }

    // 提取表格內容
    function extractTableContent(section, type) {
      const results = [];

      for (const el of section.contentElements) {
        if (el.tagName === 'TABLE') {
          const rows = el.querySelectorAll('tbody tr');
          rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length === 0) return;

            // 提取標題（第一欄，去掉連結）
            const titleCell = cells[0];
            const linkEl = titleCell.querySelector('a');
            const title = linkEl
              ? linkEl.textContent.trim()
              : titleCell.textContent.trim();

            if (type === 'western' || type === 'japan') {
              // 歐美/日本：讀中文摘要（通常是最後一欄）
              const summaryCell = cells[cells.length - 1];
              const summary = summaryCell ? summaryCell.textContent.trim() : '';
              if (summary && summary !== '-') {
                results.push(summary);
              } else if (title) {
                results.push(title);
              }
            } else {
              // 台灣/中國：只讀標題
              if (title) {
                results.push(title);
              }
            }
          });
        }
      }

      return results;
    }

    function extractNewsContent(section) {
      if (section.type === 'top10-item') {
        return extractTopNewsContent(section);
      } else if (section.type === 'table-row') {
        return section.text || '';
      }

      // 其他類型（h2 區塊標題本身不播放）
      return '';
    }

    function getNewsSections() {
      const content = document.querySelector('.content');
      if (!content) return [];

      const sections = [];
      const h2s = content.querySelectorAll('h2');
      let currentH2Type = 'other';
      let currentH2Text = '';

      // 遍歷所有元素
      const allElements = content.children;
      let currentH2 = null;
      let currentH2Elements = [];

      for (let i = 0; i < allElements.length; i++) {
        const el = allElements[i];

        if (el.tagName === 'H2') {
          // 處理之前的 h2 區塊
          if (currentH2 && currentH2Elements.length > 0) {
            processH2Section(currentH2, currentH2Elements, currentH2Type, sections);
          }

          currentH2 = el;
          currentH2Text = el.textContent;
          currentH2Type = getSectionType(currentH2Text);
          currentH2Elements = [];
        } else if (currentH2) {
          currentH2Elements.push(el);
        }
      }

      // 處理最後一個 h2 區塊
      if (currentH2 && currentH2Elements.length > 0) {
        processH2Section(currentH2, currentH2Elements, currentH2Type, sections);
      }

      return sections;
    }

    function processH2Section(h2, elements, type, sections) {
      if (type === 'top10') {
        // 頭條精選：每個 h3 是一個可播放項目
        let currentH3 = null;
        let currentH3Elements = [];

        for (const el of elements) {
          if (el.tagName === 'H3') {
            if (currentH3) {
              sections.push({
                heading: currentH3,
                contentElements: [currentH3, ...currentH3Elements],
                type: 'top10-item',
                index: sections.length
              });
            }
            currentH3 = el;
            currentH3Elements = [];
          } else if (currentH3) {
            currentH3Elements.push(el);
          }
        }

        // 最後一個 h3
        if (currentH3) {
          sections.push({
            heading: currentH3,
            contentElements: [currentH3, ...currentH3Elements],
            type: 'top10-item',
            index: sections.length
          });
        }
      } else if (type === 'western' || type === 'japan' || type === 'taiwan' || type === 'china') {
        // 表格區塊：提取每行作為可播放項目
        const tableItems = extractTableContent({
          heading: h2,
          contentElements: elements
        }, type);

        // 為 h2 添加一個播放全部的按鈕
        if (tableItems.length > 0) {
          sections.push({
            heading: h2,
            contentElements: elements,
            type: 'table-section',
            tableItems: tableItems,
            index: sections.length
          });
        }
      }
      // 其他區塊（如統計）不加入播放列表
    }

    function addPlayButtons() {
      const sections = getNewsSections();

      sections.forEach((section, index) => {
        const heading = section.heading;

        if (heading.querySelector('.item-play-btn')) return;

        const btn = document.createElement('button');
        btn.className = 'item-play-btn';
        btn.setAttribute('aria-label', '播放此新聞');
        btn.setAttribute('data-index', index);
        btn.innerHTML = `
          <svg class="play-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <svg class="stop-icon" style="display:none" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
            <rect x="6" y="6" width="12" height="12"/>
          </svg>
        `;

        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          playItem(index);
        });

        heading.appendChild(btn);
      });
    }

    async function playItem(index) {
      const sections = getNewsSections();
      if (index < 0 || index >= sections.length) return;

      if (currentPlayingIndex === index) {
        stopPlaying();
        return;
      }

      stopPlaying();

      const section = sections[index];
      currentPlayingIndex = index;

      updatePlayingUI(index, true);

      try {
        if (section.type === 'table-section') {
          // 表格區塊：播放所有項目
          for (let i = 0; i < section.tableItems.length; i++) {
            if (currentPlayingIndex !== index) break; // 被停止了
            const text = section.tableItems[i];
            if (text) {
              await speak(text);
              // 項目間短暫停頓
              if (i < section.tableItems.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 300));
              }
            }
          }
        } else {
          // 頭條項目
          const content = extractNewsContent(section);
          if (content) {
            await speak(content);
          }
        }
      } catch (e) {
        console.error('播放失敗', e);
      } finally {
        updatePlayingUI(index, false);
        currentPlayingIndex = -1;
      }
    }

    function stopPlaying() {
      stopSpeaking();
      isPlayingAll = false;
      updatePlayAllButton(false);

      if (currentPlayingIndex >= 0) {
        updatePlayingUI(currentPlayingIndex, false);
        currentPlayingIndex = -1;
      }
    }

    function updatePlayingUI(index, isPlaying) {
      const sections = getNewsSections();
      if (index < 0 || index >= sections.length) return;

      const section = sections[index];
      const btn = section.heading.querySelector('.item-play-btn');

      if (btn) {
        const playIcon = btn.querySelector('.play-icon');
        const stopIcon = btn.querySelector('.stop-icon');

        if (isPlaying) {
          btn.classList.add('playing');
          if (playIcon) playIcon.style.display = 'none';
          if (stopIcon) stopIcon.style.display = 'block';
        } else {
          btn.classList.remove('playing');
          if (playIcon) playIcon.style.display = 'block';
          if (stopIcon) stopIcon.style.display = 'none';
        }
      }
    }

    function updatePlayAllButton(isPlaying) {
      if (isPlaying) {
        playAllBtn.classList.add('playing');
        playAllIcon.innerHTML = '<rect x="6" y="6" width="12" height="12"/>';
        playAllBtn.querySelector('span').textContent = '停止播放';
      } else {
        playAllBtn.classList.remove('playing');
        playAllIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
        playAllBtn.querySelector('span').textContent = '全部播放';
      }
    }

    async function playAll() {
      if (isPlayingAll) {
        stopPlaying();
        return;
      }

      const sections = getNewsSections();
      if (sections.length === 0) return;

      isPlayingAll = true;
      updatePlayAllButton(true);

      for (let i = 0; i < sections.length; i++) {
        if (!isPlayingAll) break;

        currentPlayingIndex = i;
        updatePlayingUI(i, true);

        try {
          const section = sections[i];

          if (section.type === 'table-section') {
            // 表格區塊：播放所有項目
            for (let j = 0; j < section.tableItems.length; j++) {
              if (!isPlayingAll) break;
              const text = section.tableItems[j];
              if (text) {
                await speak(text);
                if (j < section.tableItems.length - 1) {
                  await new Promise(resolve => setTimeout(resolve, 300));
                }
              }
            }
          } else {
            // 頭條項目
            const content = extractNewsContent(section);
            if (content) {
              await speak(content);
            }
          }
        } catch (e) {
          console.error('播放失敗', e);
        } finally {
          updatePlayingUI(i, false);
        }

        if (isPlayingAll && i < sections.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 500));
        }
      }

      isPlayingAll = false;
      currentPlayingIndex = -1;
      updatePlayAllButton(false);
    }

    playAllBtn.addEventListener('click', playAll);

    autoPlayCheckbox.addEventListener('change', (e) => {
      localStorage.setItem('autoPlay', e.target.checked);
    });

    function openModal() {
      ttsEngineSelect.value = ttsConfig.engine;
      azureKeyInput.value = ttsConfig.azureKey;
      azureRegionInput.value = ttsConfig.azureRegion;
      azureProxyInput.value = ttsConfig.azureProxy;
      googleKeyInput.value = ttsConfig.googleKey;
      geminiKeyInput.value = ttsConfig.geminiKey;
      geminiVoiceSelect.value = ttsConfig.geminiVoice;
      fishKeyInput.value = ttsConfig.fishKey;
      fishVoiceInput.value = ttsConfig.fishVoice;
      fishProxyInput.value = ttsConfig.fishProxy;
      speechRateSelect.value = ttsConfig.rate.toString();

      updateEngineSettings(ttsConfig.engine);

      ttsModal.classList.add('open');
    }

    function updateEngineSettings(engine) {
      const showAzure = engine === 'azure';
      const showGoogle = engine === 'google';
      const showGemini = engine === 'gemini';
      const showFish = engine === 'fish';
      azureSettings.style.display = showAzure ? 'block' : 'none';
      azureRegionSettings.style.display = showAzure ? 'block' : 'none';
      azureProxySettings.style.display = showAzure ? 'block' : 'none';
      googleSettings.style.display = showGoogle ? 'block' : 'none';
      geminiSettings.style.display = showGemini ? 'block' : 'none';
      geminiVoiceSettings.style.display = showGemini ? 'block' : 'none';
      fishSettings.style.display = showFish ? 'block' : 'none';
      fishVoiceSettings.style.display = showFish ? 'block' : 'none';
      fishProxySettings.style.display = showFish ? 'block' : 'none';

      const hints = {
        web: 'Web Speech API 免費且無需設定，品質視瀏覽器而定',
        azure: 'Azure TTS 高品質，免費 50 萬字/月',
        google: 'Google Cloud TTS 免費 100 萬字/月',
        gemini: 'Gemini TTS 最自然，可用提示控制語調',
        fish: 'Fish Audio 台灣腔模型，自然生活感'
      };
      engineHint.textContent = hints[engine] || '';
    }

    function closeModal() {
      ttsModal.classList.remove('open');
    }

    ttsSettingsBtn.addEventListener('click', openModal);
    modalCloseBtn.addEventListener('click', closeModal);
    modalCancelBtn.addEventListener('click', closeModal);

    ttsModal.addEventListener('click', (e) => {
      if (e.target === ttsModal) {
        closeModal();
      }
    });

    ttsEngineSelect.addEventListener('change', (e) => {
      updateEngineSettings(e.target.value);
    });

    testTtsBtn.addEventListener('click', async () => {
      const originalText = testTtsBtn.textContent;
      testTtsBtn.textContent = '播放中...';
      testTtsBtn.disabled = true;

      const tempConfig = { ...ttsConfig };
      ttsConfig.engine = ttsEngineSelect.value;
      ttsConfig.azureKey = azureKeyInput.value;
      ttsConfig.azureRegion = azureRegionInput.value;
      ttsConfig.azureProxy = azureProxyInput.value;
      ttsConfig.googleKey = googleKeyInput.value;
      ttsConfig.geminiKey = geminiKeyInput.value;
      ttsConfig.geminiVoice = geminiVoiceSelect.value;
      ttsConfig.fishKey = fishKeyInput.value;
      ttsConfig.fishVoice = fishVoiceInput.value;
      ttsConfig.fishProxy = fishProxyInput.value;
      ttsConfig.rate = parseFloat(speechRateSelect.value);

      try {
        await speak('您好，這是語音測試。歡迎收聽全網新聞掃描報告。');
      } catch (e) {
        console.error('測試失敗', e);
        alert('語音測試失敗：' + e.message);
      } finally {
        ttsConfig = tempConfig;
        testTtsBtn.textContent = originalText;
        testTtsBtn.disabled = false;
      }
    });

    modalSaveBtn.addEventListener('click', () => {
      ttsConfig.engine = ttsEngineSelect.value;
      ttsConfig.azureKey = azureKeyInput.value;
      ttsConfig.azureRegion = azureRegionInput.value;
      ttsConfig.azureProxy = azureProxyInput.value;
      ttsConfig.googleKey = googleKeyInput.value;
      ttsConfig.geminiKey = geminiKeyInput.value;
      ttsConfig.geminiVoice = geminiVoiceSelect.value;
      ttsConfig.fishKey = fishKeyInput.value;
      ttsConfig.fishVoice = fishVoiceInput.value;
      ttsConfig.fishProxy = fishProxyInput.value;
      ttsConfig.rate = parseFloat(speechRateSelect.value);

      saveTtsConfig();
      updateTtsStatus();
      closeModal();
    });

    const autoplayOverlay = document.getElementById('autoplay-overlay');
    let pendingAutoplay = false;

    function showAutoplayOverlay() {
      pendingAutoplay = true;
      autoplayOverlay.classList.add('show');
    }

    function hideAutoplayOverlay() {
      autoplayOverlay.classList.remove('show');
    }

    autoplayOverlay.addEventListener('click', () => {
      hideAutoplayOverlay();
      if (pendingAutoplay) {
        pendingAutoplay = false;
        playAll();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && pendingAutoplay) {
        hideAutoplayOverlay();
        pendingAutoplay = false;
      }
    });

    loadTtsConfig();

    if ('speechSynthesis' in window) {
      speechSynthesis.getVoices();
      speechSynthesis.addEventListener('voiceschanged', () => {
        speechSynthesis.getVoices();
      });
    }

    document.addEventListener('visibilitychange', () => {
      if (document.hidden && isPlayingAll) {
        // 可選：頁面隱藏時暫停播放
      }
    });
  </script>
</body>
</html>
